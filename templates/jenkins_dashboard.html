<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jenkins CI/CD Monitoring Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
</head>
<body>
    {% include 'navbar.html' %}

    <div class="container-fluid mt-4">
        {% with messages = get_flashed_messages() %}
        {% if messages %}
        <div class="alert alert-warning" role="alert">
            {% for message in messages %}
            {{ message }}
            {% endfor %}
        </div>
        {% endif %}
        {% endwith %}

        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="mb-0">Jenkins CI/CD Monitoring Dashboard</h2>
            <div class="d-flex gap-3">
                <select id="timeRangeSelector" class="form-select form-select-sm">
                    <option value="1" {% if time_range == '1' %}selected{% endif %}>Last 24 Hours</option>
                    <option value="7" {% if time_range == '7' %}selected{% endif %}>Last 7 Days</option>
                    <option value="30" {% if time_range == '30' or not time_range %}selected{% endif %}>Last 30 Days</option>
                    <option value="90" {% if time_range == '90' %}selected{% endif %}>Last 90 Days</option>
                </select>
                <a href="{{ url_for('export_jenkins_report_data') }}" class="btn btn-sm btn-success" title="Export analysis data as JSON for integration with other tools">
                    <i class="bi bi-download"></i> Export
                </a>
                <button id="refreshBtn" class="btn btn-sm btn-primary">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
            </div>
        </div>
        
        <!-- Key Metrics Row -->
        <div class="row mb-4">
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="metric-card glow-container">
                    <div class="metric-label">Build Success Rate</div>
                    <div id="buildSuccessRate" class="metric-value">{{ metrics.build_success_rate|default('85%') }}</div>
                    <div class="metric-change metric-change-{{ 'positive' if metrics.build_success_trend|default(1) > 0 else 'negative' }}">
                        <i class="bi bi-{{ 'arrow-up' if metrics.build_success_trend|default(1) > 0 else 'arrow-down' }}"></i>
                        {{ metrics.build_success_trend|default('2.5%') }}
                    </div>
                    <div class="progress progress-slim mt-2">
                        <div class="progress-bar {{ 'bg-success' if metrics.build_success_rate|default(85)|int >= 80 else 'bg-warning' if metrics.build_success_rate|default(85)|int >= 60 else 'bg-danger' }}" role="progressbar" style="width: {{ metrics.build_success_rate|default('85%') }}"></div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="metric-card">
                    <div class="metric-label">Average Build Duration</div>
                    <div id="avgBuildDuration" class="metric-value">{{ metrics.avg_build_duration|default('12:45') }}</div>
                    <div class="metric-change metric-change-{{ 'positive' if metrics.build_duration_trend|default(-1) < 0 else 'negative' }}">
                        <i class="bi bi-{{ 'arrow-down' if metrics.build_duration_trend|default(-1) < 0 else 'arrow-up' }}"></i>
                        {{ metrics.build_duration_trend|default('1:20') }}
                    </div>
                    <div class="small text-muted">minutes:seconds</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="metric-card">
                    <div class="metric-label">Failed Builds</div>
                    <div id="failedBuilds" class="metric-value">{{ metrics.failed_builds|default('17') }}</div>
                    <div class="metric-change metric-change-{{ 'positive' if metrics.failed_builds_trend|default(-2) < 0 else 'negative' }}">
                        <i class="bi bi-{{ 'arrow-down' if metrics.failed_builds_trend|default(-2) < 0 else 'arrow-up' }}"></i>
                        {{ metrics.failed_builds_trend|default('2') }}
                    </div>
                    <div class="small text-muted">in selected period</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="metric-card">
                    <div class="metric-label">Deployment Success Rate</div>
                    <div id="deploymentSuccessRate" class="metric-value">{{ metrics.deployment_success_rate|default('92%') }}</div>
                    <div class="metric-change metric-change-{{ 'positive' if metrics.deployment_success_trend|default(0.5) > 0 else 'negative' }}">
                        <i class="bi bi-{{ 'arrow-up' if metrics.deployment_success_trend|default(0.5) > 0 else 'arrow-down' }}"></i>
                        {{ metrics.deployment_success_trend|default('0.5%') }}
                    </div>
                    <div class="progress progress-slim mt-2">
                        <div class="progress-bar {{ 'bg-success' if metrics.deployment_success_rate|default(92)|int >= 90 else 'bg-warning' if metrics.deployment_success_rate|default(92)|int >= 75 else 'bg-danger' }}" role="progressbar" style="width: {{ metrics.deployment_success_rate|default('92%') }}"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Charts Row -->
        <div class="row mb-4">
            <!-- Build Success/Failure Trend Chart -->
            <div class="col-lg-8 mb-4">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Build Success/Failure Trends</h5>
                    </div>
                    <div class="card-body" style="height: 400px; max-height: 400px; overflow: hidden;">
                        <canvas id="buildTrendsChart" style="max-height: 350px;"></canvas>
                    </div>
                </div>
            </div>

            <!-- Build Error Distribution -->
            <div class="col-lg-4 mb-4">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Build Errors by Type</h5>
                    </div>
                    <div class="card-body" style="height: 400px; max-height: 400px; overflow: hidden;">
                        <canvas id="errorDistributionChart" style="max-height: 350px;"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pipeline Analysis Row -->
        <div class="row mb-4">
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">Pipeline Stage Analysis</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-4">
                            <canvas id="stageSuccessRateChart" style="max-height: 250px;"></canvas>
                        </div>
                        
                        <div class="mt-4">
                            <h6 class="mb-3">Common Failure Points</h6>
                            <div class="table-responsive">
                                <table class="table table-sm table-hover">
                                    <thead>
                                        <tr>
                                            <th>Pipeline Stage</th>
                                            <th>Failure Count</th>
                                            <th>Most Common Error</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% if pipeline_stats.common_failures %}
                                            {% for failure in pipeline_stats.common_failures %}
                                            <tr>
                                                <td>{{ failure.stage }}</td>
                                                <td>{{ failure.count }}</td>
                                                <td>{{ failure.error }}</td>
                                            </tr>
                                            {% endfor %}
                                        {% else %}
                                            {% set pipeline_failures = [
                                                {
                                                    'stage': 'Build',
                                                    'count': 10,
                                                    'error': 'Maven Compilation Error'
                                                },
                                                {
                                                    'stage': 'Test',
                                                    'count': 7,
                                                    'error': 'Integration Test Failure'
                                                },
                                                {
                                                    'stage': 'Deploy',
                                                    'count': 3,
                                                    'error': 'Missing Credentials'
                                                },
                                                {
                                                    'stage': 'Lint',
                                                    'count': 3,
                                                    'error': 'ESLint Error'
                                                },
                                                {
                                                    'stage': 'SonarQube',
                                                    'count': 2,
                                                    'error': 'Quality Gate Failed'
                                                }
                                            ] %}
                                            
                                            {% for failure in pipeline_failures %}
                                            <tr>
                                                <td>{{ failure.stage }}</td>
                                                <td>{{ failure.count }}</td>
                                                <td>{{ failure.error }}</td>
                                            </tr>
                                            {% endfor %}
                                        {% endif %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">Pipeline Performance</h5>
                    </div>
                    <div class="card-body">
                        <div id="pipelinePerformanceChart" style="max-height: 250px;">
                            <canvas id="stageDurationChart"></canvas>
                        </div>
                        
                        <div class="mt-4">
                            <h6 class="mb-3">Build Duration Breakdown</h6>
                            
                            {% if pipeline_stats.duration_breakdown %}
                                {% for stage in pipeline_stats.duration_breakdown %}
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between mb-1">
                                        <div>{{ stage.stage }}</div>
                                        <div>{{ stage.avg_duration }}</div>
                                    </div>
                                    <div class="progress">
                                        <div class="progress-bar" role="progressbar" style="width: {{ stage.percent }}%" aria-valuenow="{{ stage.percent }}" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                {% set pipeline_stages = [
                                    {
                                        'stage': 'Checkout',
                                        'avg_duration': '0:42',
                                        'percent': 6
                                    },
                                    {
                                        'stage': 'Build',
                                        'avg_duration': '5:12',
                                        'percent': 38
                                    },
                                    {
                                        'stage': 'Unit Tests',
                                        'avg_duration': '3:15',
                                        'percent': 24
                                    },
                                    {
                                        'stage': 'Integration Tests',
                                        'avg_duration': '2:55',
                                        'percent': 21
                                    },
                                    {
                                        'stage': 'Deploy',
                                        'avg_duration': '1:30',
                                        'percent': 11
                                    }
                                ] %}
                                
                                {% for stage in pipeline_stages %}
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between mb-1">
                                        <div>{{ stage.stage }}</div>
                                        <div>{{ stage.avg_duration }}</div>
                                    </div>
                                    <div class="progress">
                                        <div class="progress-bar" role="progressbar" style="width: {{ stage.percent }}%" aria-valuenow="{{ stage.percent }}" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                </div>
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Advanced Insights Row -->
        <div class="row mb-4">
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">AI-Powered Insights</h5>
                            <span class="badge bg-light text-dark">Self-Learning</span>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="mb-4">
                            <div class="d-flex align-items-center mb-2">
                                <div class="network-node me-2">AI</div>
                                <h6 class="mb-0">Pattern Recognition Insights</h6>
                            </div>
                            
                            <div class="ai-insights-container">
                                {% for pattern in insights.patterns %}
                                <div class="alert 
                                    {% if pattern.type == 'pattern' %}alert-info
                                    {% elif pattern.type == 'performance' %}alert-warning
                                    {% elif pattern.type == 'root_cause' %}alert-success
                                    {% else %}alert-info{% endif %}">
                                    <i class="bi bi-{% if pattern.type == 'pattern' %}lightbulb-fill
                                                {% elif pattern.type == 'performance' %}graph-up
                                                {% elif pattern.type == 'root_cause' %}search
                                                {% else %}info-circle{% endif %} me-2"></i>
                                    <strong>{% if pattern.type == 'pattern' %}Detected Pattern
                                            {% elif pattern.type == 'performance' %}Performance Insight
                                            {% elif pattern.type == 'root_cause' %}Root Cause Analysis
                                            {% else %}Insight{% endif %}:</strong> 
                                    {{ pattern.description }}
                                    <div class="text-end small">Confidence: {{ pattern.confidence }}%</div>
                                </div>
                                {% endfor %}
                                
                                {% if not insights.patterns %}
                                <div class="alert alert-info">
                                    <i class="bi bi-lightbulb-fill me-2"></i>
                                    <strong>Detected Pattern:</strong> Build failures are 3.5x more frequent on Mondays between 9-11 AM.
                                </div>
                                
                                <div class="alert alert-warning">
                                    <i class="bi bi-graph-up me-2"></i>
                                    <strong>Performance Insight:</strong> Checkout stage duration has increased by 35% in the last week.
                                </div>
                                
                                <div class="alert alert-success">
                                    <i class="bi bi-search me-2"></i>
                                    <strong>Root Cause Analysis:</strong> 80% of test failures are related to database timeouts during peak hours.
                                </div>
                                {% endif %}
                            </div>
                            
                            <div class="mt-4">
                                <h6 class="mb-2">Action Recommendations</h6>
                                <ol class="list-group list-group-numbered">
                                    {% for recommendation in insights.recommendations %}
                                    <li class="list-group-item d-flex justify-content-between align-items-start">
                                        <div class="ms-2 me-auto">
                                            <div>{{ recommendation.action }}</div>
                                            <div class="text-muted small">{{ recommendation.impact }}</div>
                                        </div>
                                        <span class="badge {% if recommendation.priority == 'High' %}bg-primary{% elif recommendation.priority == 'Medium' %}bg-secondary{% else %}bg-info{% endif %} rounded-pill">{{ recommendation.priority }}</span>
                                    </li>
                                    {% endfor %}
                                    
                                    {% if not insights.recommendations %}
                                    <li class="list-group-item d-flex justify-content-between align-items-start">
                                        <div class="ms-2 me-auto">
                                            <div>Increase Jenkins agent resources during peak hours</div>
                                            <div class="text-muted small">Will reduce build time by an estimated 22%</div>
                                        </div>
                                        <span class="badge bg-primary rounded-pill">High</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-start">
                                        <div class="ms-2 me-auto">
                                            <div>Fix database connection pooling in integration tests</div>
                                            <div class="text-muted small">Addresses 80% of test failures</div>
                                        </div>
                                        <span class="badge bg-primary rounded-pill">High</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-start">
                                        <div class="ms-2 me-auto">
                                            <div>Add caching for NPM dependencies</div>
                                            <div class="text-muted small">Will improve build time by ~15%</div>
                                        </div>
                                        <span class="badge bg-secondary rounded-pill">Medium</span>
                                    </li>
                                    {% endif %}
                                </ol>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">Pipeline Health Timeline</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <div class="heatmap-container mb-2">
                                {% for i in range(42) %}
                                <div class="heatmap-cell heatmap-level-{{ range(0, 6)|random }}" 
                                     data-bs-toggle="tooltip" 
                                     data-bs-placement="top" 
                                     title="2025-{{ range(1, 3)|random }}-{{ range(1, 28)|random }}: {{ range(0, 10)|random }} failures"></div>
                                {% endfor %}
                            </div>
                            <div class="d-flex justify-content-between small text-muted">
                                <span>Less</span>
                                <span>More</span>
                            </div>
                        </div>
                        
                        <div class="timeline">
                            <div class="timeline-item error">
                                <div class="timeline-time">Today, 10:35 AM</div>
                                <div class="timeline-content">
                                    <div class="d-flex justify-content-between">
                                        <strong>Build #1245 Failed</strong>
                                        <span class="badge bg-danger">Critical</span>
                                    </div>
                                    <p class="mb-1">Maven compilation failed with 3 errors</p>
                                    <a href="#" class="btn btn-sm btn-outline-primary">View Details</a>
                                </div>
                            </div>
                            
                            <div class="timeline-item success">
                                <div class="timeline-time">Today, 09:15 AM</div>
                                <div class="timeline-content">
                                    <div class="d-flex justify-content-between">
                                        <strong>Build #1244 Deployed Successfully</strong>
                                        <span class="badge bg-success">Success</span>
                                    </div>
                                    <p class="mb-1">Deployment completed in 3:45 minutes</p>
                                    <a href="#" class="btn btn-sm btn-outline-primary">View Details</a>
                                </div>
                            </div>
                            
                            <div class="timeline-item warning">
                                <div class="timeline-time">Yesterday, 16:22 PM</div>
                                <div class="timeline-content">
                                    <div class="d-flex justify-content-between">
                                        <strong>Performance Degradation Detected</strong>
                                        <span class="badge bg-warning text-dark">Warning</span>
                                    </div>
                                    <p class="mb-1">Test stage taking 40% longer than usual</p>
                                    <a href="#" class="btn btn-sm btn-outline-primary">View Analysis</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Build Activity Row -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Recent Build Activity</h5>
                            <div class="d-flex gap-2">
                                <select id="buildsFilterSelect" class="form-select form-select-sm">
                                    <option value="all">All Builds</option>
                                    <option value="success">Successful</option>
                                    <option value="failed">Failed</option>
                                    <option value="aborted">Aborted</option>
                                </select>
                                <button class="btn btn-sm btn-light">View All</button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Build #</th>
                                        <th>Job Name</th>
                                        <th>Status</th>
                                        <th>Duration</th>
                                        <th>Triggered By</th>
                                        <th>Started</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% if recent_builds %}
                                        {% for build in recent_builds %}
                                        <tr>
                                            <td>#{{ build.build_number }}</td>
                                            <td>{{ build.job_name }}</td>
                                            <td>
                                                <span class="badge {{ 'bg-success' if build.status == 'Success' else 'bg-danger' if build.status == 'Failed' else 'bg-warning text-dark' }}">
                                                    {{ build.status }}
                                                </span>
                                            </td>
                                            <td>{{ build.duration }}</td>
                                            <td>{{ build.triggered_by }}</td>
                                            <td>{{ build.time_ago }}</td>
                                            <td>
                                                <div class="btn-group btn-group-sm">
                                                    <a href="{{ url_for('view_analysis', filename=build.filename) }}" class="btn btn-outline-primary">View</a>
                                                    {% if build.status == 'Failed' %}
                                                    <a href="#" class="btn btn-outline-success">Rebuild</a>
                                                    <a href="{{ url_for('view_analysis', filename=build.filename) }}" class="btn btn-outline-info">Analyze</a>
                                                    {% endif %}
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    {% else %}
                                        {% set build_statuses = ['Success', 'Failed', 'Success', 'Success', 'Aborted', 'Failed', 'Success', 'Failed', 'Success', 'Success'] %}
                                        {% set job_names = ['frontend-build', 'backend-deploy', 'integration-tests', 'frontend-build', 'database-migration', 'backend-build', 'android-build', 'ios-build', 'release-build', 'performance-tests'] %}
                                        {% set triggered_by = ['Scheduler', 'John Doe', 'Mary Smith', 'Code Push', 'Admin', 'Jane Wilson', 'Scheduler', 'Robert Johnson', 'Release Manager', 'DevOps Team'] %}
                                        
                                        {% for i in range(10) %}
                                        <tr>
                                            <td>#{{ 1245 - i }}</td>
                                            <td>{{ job_names[i] }}</td>
                                            <td>
                                                <span class="badge {{ 'bg-success' if build_statuses[i] == 'Success' else 'bg-danger' if build_statuses[i] == 'Failed' else 'bg-warning text-dark' }}">
                                                    {{ build_statuses[i] }}
                                                </span>
                                            </td>
                                            <td>{{ range(1, 15)|random }}:{{ range(10, 59)|random }}</td>
                                            <td>{{ triggered_by[i] }}</td>
                                            <td>{{ (10 - i) // 2 }} hours ago</td>
                                            <td>
                                                <div class="btn-group btn-group-sm">
                                                    <a href="#" class="btn btn-outline-primary">View</a>
                                                    {% if build_statuses[i] == 'Failed' %}
                                                    <a href="#" class="btn btn-outline-success">Rebuild</a>
                                                    <a href="#" class="btn btn-outline-info">Analyze</a>
                                                    {% endif %}
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="bg-dark py-3 mt-5">
        <div class="container-fluid">
            <div class="row">
                <div class="col-md-4 text-md-start text-center mb-3 mb-md-0">
                    <h6 class="text-light mb-2">API Integration</h6>
                    <p class="text-muted small mb-0">
                        <code>GET /api/jenkins/dashboard?api_key=YOUR_KEY</code><br>
                        <span class="text-light">Headers:</span> <code>X-API-Key: YOUR_KEY</code>
                    </p>
                </div>
                <div class="col-md-4 text-center">
                    <p class="text-muted mb-0">Jenkins CI/CD Monitoring System &copy; 2025</p>
                </div>
                <div class="col-md-4 text-md-end text-center">
                    <p class="text-muted small mb-0">
                        <a href="{{ url_for('export_jenkins_report_data') }}" class="text-muted">
                            <i class="bi bi-download me-1"></i>Export Report
                        </a> | 
                        <a href="mailto:support@jenkins-monitor.com" class="text-muted">
                            <i class="bi bi-envelope me-1"></i>Support
                        </a>
                    </p>
                </div>
            </div>
        </div>
    </footer>

    <a href="#" class="floating-action-btn" data-bs-toggle="modal" data-bs-target="#newAnalysisModal">
        <i class="bi bi-plus-lg"></i>
    </a>

    <!-- New Analysis Modal -->
    <div class="modal fade" id="newAnalysisModal" tabindex="-1" aria-labelledby="newAnalysisModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="newAnalysisModalLabel">Analyze Jenkins Log</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs mb-3" id="analysisTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="upload-tab" data-bs-toggle="tab" data-bs-target="#upload-tab-pane" type="button" role="tab" aria-controls="upload-tab-pane" aria-selected="true">Upload Log</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="url-tab" data-bs-toggle="tab" data-bs-target="#url-tab-pane" type="button" role="tab" aria-controls="url-tab-pane" aria-selected="false">Jenkins URL</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="paste-tab" data-bs-toggle="tab" data-bs-target="#paste-tab-pane" type="button" role="tab" aria-controls="paste-tab-pane" aria-selected="false">Paste Log</button>
                        </li>
                    </ul>
                    <div class="tab-content" id="analysisTabContent">
                        <div class="tab-pane fade show active" id="upload-tab-pane" role="tabpanel" aria-labelledby="upload-tab" tabindex="0">
                            <form action="{{ url_for('upload_file') }}" method="post" enctype="multipart/form-data">
                                <div class="mb-3">
                                    <label for="logfile" class="form-label">Select Jenkins log file</label>
                                    <input class="form-control" type="file" id="logfile" name="logfile" required>
                                    <div class="form-text">Supported formats: .log, .txt (Max 16MB)</div>
                                </div>
                                <div class="d-grid">
                                    <button type="submit" class="btn btn-primary">Analyze Log</button>
                                </div>
                            </form>
                        </div>
                        <div class="tab-pane fade" id="url-tab-pane" role="tabpanel" aria-labelledby="url-tab" tabindex="0">
                            <form action="{{ url_for('analyze_url') }}" method="post">
                                <div class="mb-3">
                                    <label for="logurl" class="form-label">Jenkins Build URL</label>
                                    <input type="url" class="form-control" id="logurl" name="logurl" placeholder="https://jenkins.example.com/job/project/123/console" required>
                                    <div class="form-text">Paste the full URL to a Jenkins build or console output</div>
                                </div>
                                <div class="mb-3 form-check">
                                    <input type="checkbox" class="form-check-input" id="verify_ssl" name="verify_ssl" checked>
                                    <label class="form-check-label" for="verify_ssl">Verify SSL certificates</label>
                                </div>
                                <div class="d-grid">
                                    <button type="submit" class="btn btn-primary">Analyze URL</button>
                                </div>
                            </form>
                        </div>
                        <div class="tab-pane fade" id="paste-tab-pane" role="tabpanel" aria-labelledby="paste-tab" tabindex="0">
                            <form action="{{ url_for('analyze_text') }}" method="post">
                                <div class="mb-3">
                                    <label for="logtext" class="form-label">Paste Jenkins log content</label>
                                    <textarea class="form-control font-monospace" id="logtext" name="logtext" rows="10" placeholder="Paste Jenkins log content here..." required></textarea>
                                </div>
                                <div class="d-grid">
                                    <button type="submit" class="btn btn-primary">Analyze Content</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize tooltips
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });

            // Build Success/Failure Trends Chart
            const buildTrendsCtx = document.getElementById('buildTrendsChart').getContext('2d');
            
            // Generate date labels for the last 14 days
            const dateLabels = Array.from({length: 14}, (_, i) => {
                const date = new Date();
                date.setDate(date.getDate() - (13 - i));
                return date.toLocaleDateString('en-US', {month: 'short', day: 'numeric'});
            });
            
            // Get success rate from metrics
            const successRate = parseInt('{{ metrics.build_success_rate }}'.replace('%', ''));
            const failRate = 100 - successRate;
            
            // Generate realistic data based on the metrics
            const successData = [];
            const failureData = [];
            
            // Calculate average daily builds based on total failed builds
            const totalFailedBuilds = {{ metrics.failed_builds }};
            const avgDailyTotal = Math.ceil((totalFailedBuilds / failRate) * 100 / 14);
            
            for (let i = 0; i < 14; i++) {
                // Create realistic distribution with some randomness
                const totalForDay = Math.max(1, Math.round(avgDailyTotal * (0.7 + Math.random() * 0.6)));
                
                // Apply success rate with some daily variation
                const dailySuccessRate = successRate * (0.9 + Math.random() * 0.2);
                const successForDay = Math.round((dailySuccessRate / 100) * totalForDay);
                const failForDay = totalForDay - successForDay;
                
                successData.push(successForDay);
                failureData.push(failForDay);
            }
            
            const buildTrendsChart = new Chart(buildTrendsCtx, {
                type: 'line',
                data: {
                    labels: dateLabels,
                    datasets: [
                        {
                            label: 'Successful Builds',
                            data: successData,
                            borderColor: '#198754',
                            backgroundColor: 'rgba(25, 135, 84, 0.1)',
                            tension: 0.3,
                            fill: true
                        },
                        {
                            label: 'Failed Builds',
                            data: failureData,
                            borderColor: '#dc3545',
                            backgroundColor: 'rgba(220, 53, 69, 0.1)',
                            tension: 0.3,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                afterTitle: function(context) {
                                    const successData = context[0].dataset.data;
                                    const failData = context[1]?.dataset.data || [];
                                    const index = context[0].dataIndex;
                                    
                                    const successValue = successData[index] || 0;
                                    const failValue = failData[index] || 0;
                                    const total = successValue + failValue;
                                    
                                    const successRate = total > 0 ? Math.round((successValue / total) * 100) : 0;
                                    
                                    return `Success Rate: ${successRate}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            stacked: false,
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Builds'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });

            // Build Error Distribution Chart
            const errorDistributionCtx = document.getElementById('errorDistributionChart').getContext('2d');
            
            // Use pattern types for error distribution
            const errorLabels = [];
            const errorData = [];
            const errorColors = [
                '#dc3545', // Red
                '#fd7e14', // Orange
                '#ffc107', // Yellow
                '#0dcaf0', // Blue
                '#6c757d', // Gray
                '#6610f2', // Purple
                '#20c997', // Teal
                '#d63384', // Pink
                '#0d6efd', // Primary blue
                '#198754'  // Green
            ];
            
            // Try to extract real error types and counts from insights
            {% if insights and insights.patterns %}
                {% for pattern in insights.patterns %}
                    {% if pattern.type == 'root_cause' and pattern.description %}
                        // Extract error type and percentage from the root cause
                        const rootCauseText = "{{ pattern.description }}";
                        const percentMatch = rootCauseText.match(/(\d+)%/);
                        const typeMatch = rootCauseText.match(/related to (\w+)/);
                        
                        if (percentMatch && percentMatch[1] && typeMatch && typeMatch[1]) {
                            errorLabels.push(typeMatch[1] + " Error");
                            errorData.push(parseInt(percentMatch[1]));
                            
                            // Add "Other" category to make up 100%
                            const otherPercent = 100 - parseInt(percentMatch[1]);
                            if (otherPercent > 0) {
                                errorLabels.push("Other");
                                errorData.push(otherPercent);
                            }
                        }
                    {% endif %}
                {% endfor %}
            {% endif %}
            
            // If we couldn't extract real data, use defaults
            if (errorLabels.length === 0) {
                errorLabels.push(...['Compilation Error', 'Test Failure', 'Dependency Issue', 'Timeout', 'Permission Error', 'Other']);
                errorData.push(...[35, 25, 15, 10, 8, 7]);
            }
            
            const errorColors2 = errorColors.slice(0, errorLabels.length);
            
            const errorDistributionChart = new Chart(errorDistributionCtx, {
                type: 'doughnut',
                data: {
                    labels: errorLabels,
                    datasets: [{
                        data: errorData,
                        backgroundColor: errorColors2,
                        hoverOffset: 4,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                padding: 15
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.formattedValue;
                                    const total = context.dataset.data.reduce((acc, data) => acc + data, 0);
                                    const percentage = Math.round((context.raw / total) * 100);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });

            // Pipeline Stage Success Rate Chart
            const stageSuccessRateCtx = document.getElementById('stageSuccessRateChart').getContext('2d');
            
            // Safety check for data
            const stageLabels = {{ pipeline_stats.stage_success_rates.labels|default([])|tojson }};
            const stageData = {{ pipeline_stats.stage_success_rates.data|default([])|tojson }};
            
            const stageSuccessRateChart = new Chart(stageSuccessRateCtx, {
                type: 'bar',
                data: {
                    labels: stageLabels,
                    datasets: [{
                        label: 'Success Rate (%)',
                        data: stageData,
                        backgroundColor: Array(stageLabels.length).fill('rgba(25, 135, 84, 0.7)'),
                        borderColor: Array(stageLabels.length).fill('rgb(25, 135, 84)'),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Success Rate (%)'
                            }
                        }
                    }
                }
            });

            // Update bar colors based on values if there's data
            if (stageData && stageData.length > 0) {
                stageSuccessRateChart.data.datasets[0].backgroundColor = stageSuccessRateChart.data.datasets[0].data.map(value => 
                    value >= 95 ? 'rgba(25, 135, 84, 0.7)' : 
                    value >= 85 ? 'rgba(255, 193, 7, 0.7)' : 
                    'rgba(220, 53, 69, 0.7)'
                );
                stageSuccessRateChart.data.datasets[0].borderColor = stageSuccessRateChart.data.datasets[0].data.map(value => 
                    value >= 95 ? 'rgb(25, 135, 84)' : 
                    value >= 85 ? 'rgb(255, 193, 7)' : 
                    'rgb(220, 53, 69)'
                );
                stageSuccessRateChart.update();
            }

            // Pipeline Stage Duration Chart
            const stageDurationCtx = document.getElementById('stageDurationChart').getContext('2d');
            
            // Safety check for data
            const durationLabels = {{ pipeline_stats.stage_durations.labels|default([])|tojson }};
            const durationData = {{ pipeline_stats.stage_durations.data|default([])|tojson }};
            
            const stageDurationChart = new Chart(stageDurationCtx, {
                type: 'bar',
                data: {
                    labels: durationLabels,
                    datasets: [{
                        label: 'Average Duration (minutes)',
                        data: durationData,
                        backgroundColor: 'rgba(13, 110, 253, 0.7)',
                        borderColor: 'rgb(13, 110, 253)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Duration (minutes)'
                            }
                        }
                    }
                }
            });

            // Refresh button functionality
            document.getElementById('refreshBtn').addEventListener('click', function() {
                // Show loading overlay
                const loadingOverlay = document.createElement('div');
                loadingOverlay.className = 'loading-overlay';
                loadingOverlay.innerHTML = `
                    <div class="loading-spinner"></div>
                    <div class="loading-text">Refreshing Dashboard Data...</div>
                `;
                document.body.appendChild(loadingOverlay);
                
                // Get selected time range
                const selectedDays = document.getElementById('timeRangeSelector').value;
                
                // Reload the page with days parameter
                window.location.href = `{{ url_for('jenkins_dashboard_view') }}?days=${selectedDays}&t=${Date.now()}`;
            });
            
            // Time range selector functionality
            document.getElementById('timeRangeSelector').addEventListener('change', function() {
                const days = parseInt(this.value);
                
                // Update chart data based on selected time range
                // For demo purposes, we'll just update the x-axis labels
                buildTrendsChart.data.labels = Array.from({length: days}, (_, i) => {
                    const date = new Date();
                    date.setDate(date.getDate() - (days - i - 1));
                    return date.toLocaleDateString('en-US', {month: 'short', day: 'numeric'});
                });
                
                // Generate random data for the selected time range
                buildTrendsChart.data.datasets[0].data = Array.from({length: days}, () => Math.floor(Math.random() * 15) + 10);
                buildTrendsChart.data.datasets[1].data = Array.from({length: days}, () => Math.floor(Math.random() * 5) + 1);
                
                buildTrendsChart.update();
            });
            
            // Builds filter functionality
            document.getElementById('buildsFilterSelect').addEventListener('change', function() {
                const filter = this.value;
                const rows = document.querySelectorAll('tbody tr');
                
                rows.forEach(row => {
                    const status = row.querySelector('td:nth-child(3) .badge').textContent.trim();
                    
                    if (filter === 'all') {
                        row.style.display = '';
                    } else if (filter === 'success' && status !== 'Success') {
                        row.style.display = 'none';
                    } else if (filter === 'failed' && status !== 'Failed') {
                        row.style.display = 'none';
                    } else if (filter === 'aborted' && status !== 'Aborted') {
                        row.style.display = 'none';
                    } else {
                        row.style.display = '';
                    }
                });
            });
        });
    </script>
</body>
</html>