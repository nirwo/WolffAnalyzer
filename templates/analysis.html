<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Log Analysis Results</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    {% include 'navbar.html' %}

    <div class="container mt-4">
        {% with messages = get_flashed_messages() %}
        {% if messages %}
        <div class="alert alert-warning" role="alert">
            {% for message in messages %}
            {{ message }}
            {% endfor %}
        </div>
        {% endif %}
        {% endwith %}

        <h2 class="mb-4">Analysis Results for: {{ original_filename }}</h2>
        {% if source_url is defined and source_url %}
        <div class="alert alert-info mb-4">
            <strong>Source URL:</strong> <a href="{{ source_url }}" target="_blank" class="text-info">{{ source_url }}</a>
        </div>
        {% endif %}

        {% if analysis.analysis_error is defined %}
        <div class="analysis-failure-notice card bg-dark text-light mb-4 border-danger">
            <div class="card-header bg-danger text-white">
                <h4 class="mb-0"><i class="bi bi-exclamation-triangle-fill"></i> Advanced Analysis Failed</h4>
            </div>
            <div class="card-body">
                <p><strong>Error type:</strong> {{ analysis.analysis_error.type }}</p>
                <p><strong>Error details:</strong> {{ analysis.analysis_error.message }}</p>
                {% if analysis.analysis_error.location %}
                <p><strong>Location:</strong> {{ analysis.analysis_error.location }}</p>
                {% endif %}
                <p class="mb-0">Basic analysis is still available below. See recommendations for troubleshooting steps.</p>
            </div>
        </div>
        {% endif %}
        
        {% if analysis.jenkins_specific_issues is defined and analysis.jenkins_specific_issues|length > 0 %}
        <div class="card mb-4 critical-highlight">
            <div class="card-header bg-danger">
                <h5 class="mb-0"><i class="bi bi-jenkins"></i> Jenkins Build Issues</h5>
            </div>
            <div class="card-body">
                <ul class="list-group">
                    {% for issue in analysis.jenkins_specific_issues %}
                    <li class="list-group-item d-flex justify-content-between align-items-start">
                        <div class="ms-2 me-auto">
                            <div class="fw-bold">{{ issue.pattern_name }}</div>
                            <p>{{ issue.description }}</p>
                            <div class="matched-line text-muted small mb-2">{{ issue.matched_line|truncate(100) }}</div>
                            <div class="quick-fix">
                                <i class="bi bi-tools"></i> <strong>Quick fix:</strong> {{ issue.suggestion }}
                            </div>
                        </div>
                        <span class="badge bg-danger rounded-pill">{{ issue.severity }}</span>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        {% elif analysis.critical_messages is defined and analysis.critical_messages|length > 0 %}
        <div class="card mb-4 critical-highlight">
            <div class="card-header bg-danger">
                <h5 class="mb-0"><i class="bi bi-lightning-charge-fill"></i> Critical Issues Requiring Immediate Attention</h5>
            </div>
            <div class="card-body">
                <ul class="list-group">
                    {% for issue in analysis.critical_messages %}
                    <li class="list-group-item d-flex justify-content-between align-items-start">
                        <div class="ms-2 me-auto">
                            <div class="fw-bold">{{ issue.component }}</div>
                            {{ issue.message }}
                            <div class="quick-fix">
                                <i class="bi bi-tools"></i> <strong>Quick fix:</strong> Check the component's configuration and logs for errors
                            </div>
                        </div>
                        <span class="badge bg-danger rounded-pill">{{ issue.timestamp }}</span>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        {% endif %}

        <div class="row">
            <!-- Summary Card -->
            <div class="col-lg-12 mb-4">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Analysis Summary</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="row mb-3">
                                    <div class="col-12 text-center">
                                        <div class="alert {% if analysis.critical_issues_count > 5 %}alert-danger{% elif analysis.critical_issues_count > 0 %}alert-warning{% else %}alert-success{% endif %}">
                                            <h5>Issues Summary</h5>
                                            <div class="d-flex justify-content-around">
                                                <div class="text-center {% if analysis.error_by_level is defined and analysis.error_by_level.CRITICAL > 0 %}critical-highlight p-2 rounded{% endif %}">
                                                    <div class="fs-5">Critical</div>
                                                    <h3>{{ analysis.error_by_level.CRITICAL if analysis.error_by_level is defined else 0 }}</h3>
                                                </div>
                                                <div class="text-center {% if analysis.error_by_level is defined and analysis.error_by_level.ERROR > 5 %}critical-highlight p-2 rounded{% endif %}">
                                                    <div class="fs-5">Errors</div>
                                                    <h3>{{ analysis.error_by_level.ERROR if analysis.error_by_level is defined else 0 }}</h3>
                                                </div>
                                                <div class="text-center">
                                                    <div class="fs-5">Warnings</div>
                                                    <h3>{{ analysis.error_by_level.WARNING if analysis.error_by_level is defined else 0 }}</h3>
                                                </div>
                                            </div>
                                            <div class="mt-2">
                                                <span class="badge bg-secondary">Total: {{ analysis.total_issues if analysis.total_issues is defined else entries|length }}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <h5>Problematic Components</h5>
                                <ul class="list-group mb-3">
                                    {% for component, count in analysis.problematic_components %}
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        {{ component }}
                                        <span class="badge bg-primary rounded-pill">{{ count }} issues</span>
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>
                            
                            <div class="col-md-8">
                                <h5>Most Common Errors</h5>
                                <div class="list-group">
                                    {% if analysis.most_common_errors is mapping %}
                                        {% for error_type, count in analysis.most_common_errors %}
                                        <div class="list-group-item">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <h6 class="mb-1">{{ error_type }}</h6>
                                                <span class="badge bg-danger rounded-pill">{{ count }}</span>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    {% else %}
                                        {% for error in analysis.most_common_errors %}
                                        <div class="list-group-item">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <h6 class="mb-1">{{ error.error_type if error is mapping and 'error_type' in error else error[0] if error is sequence else error }}</h6>
                                                <span class="badge bg-danger rounded-pill">{{ error.count if error is mapping and 'count' in error else error[1] if error is sequence else 1 }}</span>
                                            </div>
                                            {% if error is mapping and 'example' in error %}
                                            <p class="mb-1 text-muted small">{{ error.example }}</p>
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    {% if error.affects_components is defined %}
                                                    <span class="badge bg-info text-dark">Affects: 
                                                    {% for comp in error.affects_components %}
                                                        {{ comp }}{% if not loop.last %}, {% endif %}
                                                    {% endfor %}
                                                    </span>
                                                    {% endif %}
                                                </div>
                                                {% if error.first_seen is defined and error.last_seen is defined %}
                                                <small class="text-muted">
                                                    First: {{ error.first_seen }} <br>
                                                    Last: {{ error.last_seen }}
                                                </small>
                                                {% endif %}
                                            </div>
                                            {% endif %}
                                        </div>
                                        {% endfor %}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recommendations Card -->
            <div class="col-lg-12 mb-4">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">Recommendations</h5>
                    </div>
                    <div class="card-body">
                        <div class="accordion" id="recommendationsAccordion">
                            {% for rec in recommendations %}
                            {% set i = loop.index0 %}
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="heading{{ i }}">
                                    <button class="accordion-button {% if i != 0 %}collapsed{% endif %}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ i }}" aria-expanded="{{ 'true' if i == 0 else 'false' }}" aria-controls="collapse{{ i }}">
                                        {{ rec.title }}
                                    </button>
                                </h2>
                                <div id="collapse{{ i }}" class="accordion-collapse collapse {% if i == 0 %}show{% endif %}" aria-labelledby="heading{{ i }}" data-bs-parent="#recommendationsAccordion">
                                    <div class="accordion-body">
                                        <p>{{ rec.description }}</p>
                                        <h6>Recommended Steps:</h6>
                                        <ol class="list-group list-group-numbered">
                                            {% for step in rec.steps %}
                                            <li class="list-group-item">{{ step }}</li>
                                            {% endfor %}
                                        </ol>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Error Timeline Card -->
            <div class="col-lg-12 mb-4">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Error Timeline</h5>
                    </div>
                    <div class="card-body">
                        <div class="card mb-3">
                            <div class="card-header">
                                <div class="row align-items-center">
                                    <div class="col-md-6">
                                        <h5 class="mb-0">Error Timeline</h5>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="d-flex justify-content-end">
                                            <div class="input-group">
                                                <input type="text" id="entryFilter" class="form-control form-control-sm" placeholder="Filter by keyword...">
                                                <select id="levelFilter" class="form-select form-select-sm">
                                                    <option value="all">All Levels</option>
                                                    <option value="ERROR">ERROR</option>
                                                    <option value="CRITICAL">CRITICAL</option>
                                                    <option value="FATAL">FATAL</option>
                                                    <option value="WARNING">WARNING</option>
                                                    <option value="EXCEPTION">EXCEPTION</option>
                                                    <option value="INFO">INFO</option>
                                                </select>
                                                <button class="btn btn-sm btn-outline-secondary" type="button" id="clearFilters">Clear</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="entriesTable">
                                <thead>
                                    <tr>
                                        <th>Timestamp</th>
                                        <th>Level</th>
                                        <th>Component</th>
                                        <th>Message</th>
                                        <th>Details</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for entry in entries %}
                                    <tr class="{% if entry.level == 'ERROR' %}table-danger{% elif entry.level == 'WARNING' or entry.level == 'WARN' %}table-warning{% elif entry.level == 'CRITICAL' or entry.level == 'FATAL' %}table-dark{% else %}{% endif %}">
                                        <td>{{ entry.timestamp or 'N/A' }}</td>
                                        <td>
                                            <span class="badge {% if entry.level == 'ERROR' %}bg-danger{% elif entry.level == 'WARNING' or entry.level == 'WARN' %}bg-warning text-dark{% elif entry.level == 'CRITICAL' or entry.level == 'FATAL' %}bg-dark{% elif entry.level == 'INFO' %}bg-info text-dark{% else %}bg-secondary{% endif %}">
                                                {{ entry.level }}
                                            </span>
                                        </td>
                                        <td class="text-wrap">{{ entry.component }}</td>
                                        <td class="text-wrap">{{ entry.message|truncate(100) }}</td>
                                        <td>
                                            <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#entryModal{{ loop.index }}">
                                                <i class="bi bi-search"></i> View
                                            </button>
                                        </td>
                                    </tr>

                                    <!-- Modal for each entry -->
                                    <div class="modal fade" id="entryModal{{ loop.index }}" tabindex="-1" aria-labelledby="entryModalLabel{{ loop.index }}" aria-hidden="true">
                                        <div class="modal-dialog modal-lg">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title" id="entryModalLabel{{ loop.index }}">Log Entry Details</h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                </div>
                                                <div class="modal-body">
                                                    <div class="alert {% if entry.level == 'ERROR' %}alert-danger{% elif entry.level == 'WARNING' or entry.level == 'WARN' %}alert-warning{% elif entry.level == 'CRITICAL' or entry.level == 'FATAL' %}alert-dark{% else %}alert-info{% endif %} mb-3">
                                                        <div class="row">
                                                            <div class="col-md-6">
                                                                <strong>Timestamp:</strong> {{ entry.timestamp or 'Not available' }}
                                                            </div>
                                                            <div class="col-md-6">
                                                                <strong>Component:</strong> {{ entry.component }}
                                                            </div>
                                                        </div>
                                                        <div class="row mt-1">
                                                            <div class="col-md-6">
                                                                <strong>Severity:</strong> {{ entry.level }} ({{ entry.severity }})
                                                            </div>
                                                            <div class="col-md-6">
                                                                <strong>Line Number:</strong> {{ entry.line_number }}
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="mb-3">
                                                        <h5>Message</h5>
                                                        <pre class="bg-dark text-light p-3 rounded border text-wrap">{{ entry.message }}</pre>
                                                    </div>
                                                    
                                                    {% if entry.matched_pattern is defined and entry.matched_pattern %}
                                                    <div class="mb-3 pattern-match-section">
                                                        <h5><i class="bi bi-lightning-charge-fill text-warning"></i> Matched Pattern</h5>
                                                        <div class="card border-warning">
                                                            <div class="card-header d-flex justify-content-between align-items-center">
                                                                <span><strong>{{ entry.matched_pattern.name }}</strong> ({{ entry.matched_pattern.severity }})</span>
                                                                <button class="btn btn-sm btn-warning edit-pattern-btn" 
                                                                        data-pattern-id="{{ entry.matched_pattern.id }}"
                                                                        data-pattern-name="{{ entry.matched_pattern.name }}"
                                                                        data-pattern-regex="{{ entry.matched_pattern.pattern }}"
                                                                        data-bs-toggle="modal" 
                                                                        data-bs-target="#fixPatternModal">
                                                                    <i class="bi bi-pencil-square"></i> Fix Pattern
                                                                </button>
                                                            </div>
                                                            <div class="card-body">
                                                                <p class="mb-1"><strong>Pattern:</strong> <code>{{ entry.matched_pattern.pattern }}</code></p>
                                                                <p class="mb-1"><strong>Description:</strong> {{ entry.matched_pattern.description }}</p>
                                                                <p class="mb-0"><strong>Suggestion:</strong> {{ entry.matched_pattern.suggestion }}</p>
                                                            </div>
                                                            <div class="card-footer">
                                                                <div class="small text-muted">
                                                                    <span class="badge {% if entry.false_positive %}bg-danger{% else %}bg-success{% endif %}">
                                                                        {{ "Potential False Positive" if entry.false_positive else "True Positive" }}
                                                                    </span>
                                                                    <button class="btn btn-sm btn-outline-danger ms-2 report-false-positive" 
                                                                            data-entry-id="{{ loop.index }}"
                                                                            data-pattern-id="{{ entry.matched_pattern.id }}">
                                                                        Report False Positive
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    {% endif %}
                                                    
                                                    {% if entry.raw_message is defined and entry.raw_message != entry.message %}
                                                    <div class="mb-3">
                                                        <h6>Raw Message</h6>
                                                        <pre class="bg-dark text-light p-3 rounded border text-wrap">{{ entry.raw_message }}</pre>
                                                    </div>
                                                    {% endif %}
                                                    
                                                    <div class="mb-3">
                                                        <h6>Context (surrounding lines)</h6>
                                                        <div class="context-container">
                                                            <pre class="bg-dark text-light p-3 rounded border text-wrap" id="context-{{ loop.index }}">{% for context_line in entry.context %}{% if context_line == entry.raw_message %}<span class="error-line">{{ context_line }}</span>{% else %}{{ context_line }}{% endif %}
{% endfor %}</pre>
                                                            <div class="d-flex justify-content-between mt-2">
                                                                <button type="button" class="btn btn-sm btn-success create-pattern-btn"
                                                                        data-message="{{ entry.message }}"
                                                                        data-component="{{ entry.component }}"
                                                                        data-level="{{ entry.level }}"
                                                                        data-bs-toggle="modal"
                                                                        data-bs-target="#createPatternModal">
                                                                    <i class="bi bi-plus-circle"></i> Create Pattern from Log
                                                                </button>
                                                                <button type="button" class="btn btn-sm btn-outline-primary jump-to-error" data-error-line="{{ entry.line_number }}">
                                                                    <i class="bi bi-arrow-right-circle"></i> Jump to Line {{ entry.line_number }}
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="mb-3">
                                                        <h6>Possible Causes</h6>
                                                        <ul class="list-group">
                                                            {% if 'connection' in entry.message.lower() %}
                                                                <li class="list-group-item">Network connectivity issue or service unavailable</li>
                                                            {% endif %}
                                                            {% if 'timeout' in entry.message.lower() %}
                                                                <li class="list-group-item">Operation took too long to complete</li>
                                                            {% endif %}
                                                            {% if 'permission' in entry.message.lower() or 'access' in entry.message.lower() %}
                                                                <li class="list-group-item">Insufficient permissions or authentication issues</li>
                                                            {% endif %}
                                                            {% if 'file' in entry.message.lower() and ('not found' in entry.message.lower() or 'missing' in entry.message.lower()) %}
                                                                <li class="list-group-item">Required file is missing or inaccessible</li>
                                                            {% endif %}
                                                            {% if 'memory' in entry.message.lower() %}
                                                                <li class="list-group-item">System running out of memory resources</li>
                                                            {% endif %}
                                                            <li class="list-group-item">Check the component logs for more details</li>
                                                        </ul>
                                                    </div>
                                                    
                                                    {% if entry.similar_errors is defined and entry.similar_errors|length > 0 %}
                                                    <div class="mb-3">
                                                        <h6>Similar Errors</h6>
                                                        <div class="list-group">
                                                            {% for similar in entry.similar_errors %}
                                                            <div class="list-group-item list-group-item-action">
                                                                <div class="d-flex w-100 justify-content-between">
                                                                    <h6 class="mb-1">{{ similar.component }}</h6>
                                                                    <small>{{ similar.timestamp }}</small>
                                                                </div>
                                                                <p class="mb-1 small">{{ similar.message|truncate(100) }}</p>
                                                            </div>
                                                            {% endfor %}
                                                        </div>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-outline-primary copy-btn" 
                                                            data-content="{{ entry.raw_message if entry.raw_message is defined else entry.message }}">
                                                        <i class="bi bi-clipboard"></i> Copy Message
                                                    </button>
                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Error Chains Card -->
            {% if analysis.error_chains %}
            <div class="col-lg-12 mb-4">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">Error Chains</h5>
                    </div>
                    <div class="card-body">
                        <p class="card-text">The following errors appear to be related and might indicate cascading failures:</p>
                        <div class="list-group">
                            {% for chain in analysis.error_chains %}
                            <div class="list-group-item">
                                <div class="row">
                                    <div class="col-md-5">
                                        <h6>Initial Error</h6>
                                        <pre class="bg-dark text-light p-2 rounded border small">{{ chain.from.message }}</pre>
                                        <p class="mb-0 small text-muted">{{ chain.from.timestamp }} - {{ chain.from.component }}</p>
                                    </div>
                                    <div class="col-md-2 d-flex align-items-center justify-content-center">
                                        <i class="bi bi-arrow-right fs-2"></i>
                                    </div>
                                    <div class="col-md-5">
                                        <h6>Subsequent Error</h6>
                                        <pre class="bg-dark text-light p-2 rounded border small">{{ chain.to.message }}</pre>
                                        <p class="mb-0 small text-muted">{{ chain.to.timestamp }} - {{ chain.to.component }}</p>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <div class="d-flex justify-content-between mb-4">
            <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">Back to Home</a>
            <button class="btn btn-primary" onclick="window.print()">Print/Save Report</button>
        </div>
    </div>

    <footer class="bg-dark py-3 mt-5">
        <div class="container text-center">
            <p class="text-muted mb-0">Log Analyzer &copy; 2025</p>
        </div>
    </footer>

    <!-- Fix Pattern Modal -->
    <div class="modal fade" id="fixPatternModal" tabindex="-1" aria-labelledby="fixPatternModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title" id="fixPatternModalLabel">Fix Error Pattern</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="fixPatternForm" action="{{ url_for('fix_pattern') }}" method="post">
                        <input type="hidden" id="editPatternId" name="pattern_id">
                        
                        <div class="mb-3">
                            <label for="editPatternName" class="form-label">Pattern Name</label>
                            <input type="text" class="form-control" id="editPatternName" name="pattern_name" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="editPatternRegex" class="form-label">Pattern Regex</label>
                            <div class="input-group">
                                <input type="text" class="form-control font-monospace" id="editPatternRegex" name="pattern_regex" required>
                                <button class="btn btn-outline-primary" type="button" id="testRegexBtn">Test</button>
                            </div>
                            <div class="form-text">Use regular expressions to match log entries. Example: <code>Error:.*timeout</code></div>
                        </div>
                        
                        <div class="mb-3 d-none" id="regexTestResult">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">Pattern Test Results</h6>
                                </div>
                                <div class="card-body">
                                    <div id="matchResults" class="mb-2"></div>
                                    <pre id="matchPreview" class="bg-dark text-light p-2 rounded"></pre>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="editPatternType" class="form-label">Pattern Type</label>
                            <select class="form-select" id="editPatternType" name="pattern_type" required>
                                <option value="jenkins">Jenkins-specific</option>
                                <option value="system">System/General</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="editSeverity" class="form-label">Severity</label>
                            <select class="form-select" id="editSeverity" name="severity" required>
                                <option value="critical">Critical</option>
                                <option value="error">Error</option>
                                <option value="warning">Warning</option>
                                <option value="info">Info</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="editDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="editDescription" name="description" rows="2" required></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label for="editSuggestion" class="form-label">Fix Suggestion</label>
                            <textarea class="form-control" id="editSuggestion" name="suggestion" rows="2" required></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="excludePathsCheck" name="exclude_paths">
                                <label class="form-check-label" for="excludePathsCheck">
                                    Exclude Windows/Unix paths from matches
                                </label>
                                <div class="form-text">Helps avoid false positives when paths contain error-like keywords</div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="excludeTimestampCheck" name="exclude_timestamp">
                                <label class="form-check-label" for="excludeTimestampCheck">
                                    Exclude timestamps from matches
                                </label>
                                <div class="form-text">Prevents matching datetime values as components or errors</div>
                            </div>
                        </div>
                        
                        <input type="hidden" id="currentLogId" name="log_id" value="{{ log_id if log_id is defined else '' }}">
                        <input type="hidden" id="testType" name="test_type" value="fix">
                    </form>
                </div>
                <div class="modal-footer">
                    <div class="d-flex justify-content-between w-100">
                        <div>
                            <button type="button" class="btn btn-outline-danger" id="deletePatternBtn">Delete Pattern</button>
                        </div>
                        <div>
                            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" id="savePatternBtn">Save Changes</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Pattern Modal -->
    <div class="modal fade" id="createPatternModal" tabindex="-1" aria-labelledby="createPatternModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="createPatternModalLabel">Create New Pattern from Log</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="createPatternForm" action="{{ url_for('add_pattern') }}" method="post">
                        <div class="mb-3">
                            <label for="newPatternName" class="form-label">Pattern Name</label>
                            <input type="text" class="form-control" id="newPatternName" name="pattern_name" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="logMessage" class="form-label">Log Message</label>
                            <div class="input-group">
                                <textarea class="form-control font-monospace" id="logMessage" name="log_message" rows="3" readonly></textarea>
                                <button class="btn btn-outline-secondary" type="button" id="editLogBtn">Edit</button>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="generatedRegex" class="form-label">Generated Pattern</label>
                            <div class="input-group">
                                <input type="text" class="form-control font-monospace" id="generatedRegex" name="pattern_regex" required>
                                <button class="btn btn-outline-primary" type="button" id="newTestRegexBtn">Test</button>
                                <button class="btn btn-outline-secondary" type="button" id="regenerateBtn">Regenerate</button>
                            </div>
                            <div class="form-text">Pattern is auto-generated from the log message. You can edit it to make it more specific or general.</div>
                        </div>
                        
                        <div class="mb-3 d-none" id="newRegexTestResult">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">Pattern Test Results</h6>
                                </div>
                                <div class="card-body">
                                    <div id="newMatchResults" class="mb-2"></div>
                                    <pre id="newMatchPreview" class="bg-dark text-light p-2 rounded"></pre>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="newPatternType" class="form-label">Pattern Type</label>
                            <select class="form-select" id="newPatternType" name="pattern_type" required>
                                <option value="system" selected>System/General</option>
                                <option value="jenkins">Jenkins-specific</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="newSeverity" class="form-label">Severity</label>
                            <select class="form-select" id="newSeverity" name="severity" required>
                                <option value="error" selected>Error</option>
                                <option value="critical">Critical</option>
                                <option value="warning">Warning</option>
                                <option value="info">Info</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="newDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="newDescription" name="description" rows="2" required></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label for="newSuggestion" class="form-label">Fix Suggestion</label>
                            <textarea class="form-control" id="newSuggestion" name="suggestion" rows="2" required></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="newExcludePathsCheck" name="exclude_paths" checked>
                                <label class="form-check-label" for="newExcludePathsCheck">
                                    Exclude Windows/Unix paths from matches
                                </label>
                                <div class="form-text">Helps avoid false positives when paths contain error-like keywords</div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="newExcludeTimestampCheck" name="exclude_timestamp" checked>
                                <label class="form-check-label" for="newExcludeTimestampCheck">
                                    Exclude timestamps from matches
                                </label>
                                <div class="form-text">Prevents matching datetime values as components or errors</div>
                            </div>
                        </div>
                        
                        <input type="hidden" id="newCurrentLogId" name="log_id" value="{{ log_id if log_id is defined else '' }}">
                        <input type="hidden" id="newTestType" name="test_type" value="new">
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" id="createPatternBtn">Create Pattern</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Entry filtering functionality
            const entryFilter = document.getElementById('entryFilter');
            const levelFilter = document.getElementById('levelFilter');
            const clearButton = document.getElementById('clearFilters');
            const entriesTable = document.getElementById('entriesTable');
            const tableRows = entriesTable.querySelectorAll('tbody tr');
            
            // Function to filter table rows
            function filterTableRows() {
                const keyword = entryFilter.value.toLowerCase();
                const level = levelFilter.value;
                
                tableRows.forEach(row => {
                    const timestamp = row.cells[0].textContent.toLowerCase();
                    const rowLevel = row.cells[1].textContent.trim();
                    const component = row.cells[2].textContent.toLowerCase();
                    const message = row.cells[3].textContent.toLowerCase();
                    
                    const matchesKeyword = !keyword || 
                                          timestamp.includes(keyword) || 
                                          component.includes(keyword) || 
                                          message.includes(keyword);
                                          
                    const matchesLevel = level === 'all' || rowLevel === level;
                    
                    if (matchesKeyword && matchesLevel) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            }
            
            // Set up event listeners
            entryFilter.addEventListener('input', filterTableRows);
            levelFilter.addEventListener('change', filterTableRows);
            
            // Clear filters
            clearButton.addEventListener('click', function() {
                entryFilter.value = '';
                levelFilter.value = 'all';
                filterTableRows();
            });
            
            // Line highlighting and bookmarking
            const entryRows = document.querySelectorAll('tbody tr');
            entryRows.forEach(row => {
                row.addEventListener('click', function() {
                    // Toggle 'selected' class for highlighting
                    if (!event.target.closest('button')) {
                        entryRows.forEach(r => r.classList.remove('highlight-row'));
                        this.classList.add('highlight-row');
                    }
                });
            });
            
            // Copy functionality for error messages
            const copyButtons = document.querySelectorAll('.copy-btn');
            copyButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const content = this.dataset.content;
                    navigator.clipboard.writeText(content)
                        .then(() => {
                            // Show copy confirmation
                            const originalText = this.innerHTML;
                            this.innerHTML = '<i class="bi bi-check"></i> Copied!';
                            setTimeout(() => {
                                this.innerHTML = originalText;
                            }, 1500);
                        })
                        .catch(err => {
                            console.error('Failed to copy: ', err);
                        });
                });
            });
            
            // Jump to error line functionality
            const jumpButtons = document.querySelectorAll('.jump-to-error');
            jumpButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const lineNumber = this.dataset.errorLine;
                    const errorElement = document.getElementById(`line-${lineNumber}`);
                    
                    if (errorElement) {
                        // Scroll to the element and highlight it
                        errorElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        errorElement.classList.add('highlight-line');
                        
                        // Remove the highlight after a delay
                        setTimeout(() => {
                            errorElement.classList.remove('highlight-line');
                        }, 3000);
                    } else {
                        // If line not found, offer to show full log
                        if (confirm('Line not visible in current view. Would you like to see the raw log file?')) {
                            const logPath = '{{ filename }}';
                            // This would need to be implemented - redirecting to view the full raw log file
                            window.open(`/rawlog/${logPath}`, '_blank');
                        }
                    }
                });
            });

            // Add line numbers to log entries
            const addLineNumbers = () => {
                const logEntries = document.querySelectorAll('.error-line');
                logEntries.forEach(entry => {
                    const lineText = entry.textContent;
                    const lineDiv = document.createElement('div');
                    lineDiv.className = 'line-number';
                    lineDiv.textContent = '!'; // Indicator for error line
                    entry.parentNode.insertBefore(lineDiv, entry);
                });
            };
            
            // Call the function to add line numbers
            addLineNumbers();
            
            // Initialize tooltips
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
            
            // Edit pattern button event handlers
            const editPatternButtons = document.querySelectorAll('.edit-pattern-btn');
            editPatternButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const patternId = this.dataset.patternId;
                    const patternName = this.dataset.patternName;
                    const patternRegex = this.dataset.patternRegex;
                    
                    // Fill the form with pattern data
                    document.getElementById('editPatternId').value = patternId;
                    document.getElementById('editPatternName').value = patternName;
                    document.getElementById('editPatternRegex').value = patternRegex;
                    
                    // Fetch the rest of the pattern data from the server
                    fetch(`/api/pattern/${patternId}`)
                        .then(response => response.json())
                        .then(data => {
                            document.getElementById('editPatternType').value = data.type;
                            document.getElementById('editSeverity').value = data.severity;
                            document.getElementById('editDescription').value = data.description;
                            document.getElementById('editSuggestion').value = data.suggestion;
                            document.getElementById('excludePathsCheck').checked = data.exclude_paths || false;
                            document.getElementById('excludeTimestampCheck').checked = data.exclude_timestamp || false;
                        })
                        .catch(error => {
                            console.error('Error fetching pattern details:', error);
                        });
                });
            });
            
            // Create pattern from log button
            const createPatternButtons = document.querySelectorAll('.create-pattern-btn');
            createPatternButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const message = this.dataset.message;
                    const component = this.dataset.component;
                    const level = this.dataset.level;
                    
                    // Fill the form with log data
                    document.getElementById('logMessage').value = message;
                    
                    // Generate a suggested regex pattern from the message
                    const escapedMessage = message
                        .replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&') // Escape regex special chars
                        .replace(/\d+/g, '\\d+') // Replace numbers with digit pattern
                        .replace(/[a-fA-F0-9]{8}-[a-fA-F0-9]{4}-[a-fA-F0-9]{4}-[a-fA-F0-9]{4}-[a-fA-F0-9]{12}/g, '[a-fA-F0-9\\-]+'); // Replace UUIDs
                    
                    // Generate a name from the message or component
                    let suggestedName = '';
                    if (component && component !== 'Unknown') {
                        suggestedName = `${component} ${level.toLowerCase()}`;
                    } else {
                        // Extract key words from the message
                        const words = message.split(/\s+/).filter(word => word.length > 3);
                        suggestedName = words.slice(0, 3).join(' ');
                    }
                    
                    document.getElementById('newPatternName').value = suggestedName;
                    document.getElementById('generatedRegex').value = escapedMessage;
                    
                    // Set default severity based on log level
                    if (level === 'ERROR') {
                        document.getElementById('newSeverity').value = 'error';
                    } else if (level === 'WARNING' || level === 'WARN') {
                        document.getElementById('newSeverity').value = 'warning';
                    } else if (level === 'CRITICAL' || level === 'FATAL') {
                        document.getElementById('newSeverity').value = 'critical';
                    } else {
                        document.getElementById('newSeverity').value = 'info';
                    }
                    
                    // Generate description and suggestion
                    document.getElementById('newDescription').value = `${component || 'System'} error: ${message.substring(0, 100)}`;
                    document.getElementById('newSuggestion').value = 'Investigate the error in the affected component logs';
                });
            });
            
            // Test regex functionality
            document.getElementById('testRegexBtn').addEventListener('click', function() {
                const regex = document.getElementById('editPatternRegex').value;
                const logId = document.getElementById('currentLogId').value;
                
                // Show testing UI
                document.getElementById('regexTestResult').classList.remove('d-none');
                document.getElementById('matchResults').innerHTML = '<div class="spinner-border spinner-border-sm text-primary" role="status"><span class="visually-hidden">Loading...</span></div> Testing pattern...';
                
                // Test the regex against the current log
                fetch(`/api/test_pattern?regex=${encodeURIComponent(regex)}&log_id=${logId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            document.getElementById('matchResults').innerHTML = 
                                `<div class="alert ${data.matches.length > 0 ? 'alert-success' : 'alert-warning'}">
                                    <strong>${data.matches.length}</strong> matches found
                                </div>`;
                            
                            if (data.matches.length > 0) {
                                const preview = data.matches.slice(0, 5).map(match => {
                                    return `<div class="match-line">${match}</div>`;
                                }).join('\n');
                                
                                document.getElementById('matchPreview').innerHTML = preview;
                                
                                if (data.matches.length > 5) {
                                    document.getElementById('matchPreview').innerHTML += `\n<div class="text-muted">...and ${data.matches.length - 5} more matches</div>`;
                                }
                            } else {
                                document.getElementById('matchPreview').innerHTML = '<div class="text-muted">No matches found. Try adjusting your pattern.</div>';
                            }
                        } else {
                            document.getElementById('matchResults').innerHTML = 
                                `<div class="alert alert-danger">
                                    Error testing pattern: ${data.error}
                                </div>`;
                            document.getElementById('matchPreview').innerHTML = '';
                        }
                    })
                    .catch(error => {
                        document.getElementById('matchResults').innerHTML = 
                            `<div class="alert alert-danger">
                                Network error while testing pattern
                            </div>`;
                        console.error('Error testing pattern:', error);
                    });
            });
            
            // New pattern test regex functionality
            document.getElementById('newTestRegexBtn').addEventListener('click', function() {
                const regex = document.getElementById('generatedRegex').value;
                const logId = document.getElementById('newCurrentLogId').value;
                
                // Show testing UI
                document.getElementById('newRegexTestResult').classList.remove('d-none');
                document.getElementById('newMatchResults').innerHTML = '<div class="spinner-border spinner-border-sm text-primary" role="status"><span class="visually-hidden">Loading...</span></div> Testing pattern...';
                
                // Test the regex against the current log
                fetch(`/api/test_pattern?regex=${encodeURIComponent(regex)}&log_id=${logId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            document.getElementById('newMatchResults').innerHTML = 
                                `<div class="alert ${data.matches.length > 0 ? 'alert-success' : 'alert-warning'}">
                                    <strong>${data.matches.length}</strong> matches found
                                </div>`;
                            
                            if (data.matches.length > 0) {
                                const preview = data.matches.slice(0, 5).map(match => {
                                    return `<div class="match-line">${match}</div>`;
                                }).join('\n');
                                
                                document.getElementById('newMatchPreview').innerHTML = preview;
                                
                                if (data.matches.length > 5) {
                                    document.getElementById('newMatchPreview').innerHTML += `\n<div class="text-muted">...and ${data.matches.length - 5} more matches</div>`;
                                }
                            } else {
                                document.getElementById('newMatchPreview').innerHTML = '<div class="text-muted">No matches found. Try adjusting your pattern.</div>';
                            }
                        } else {
                            document.getElementById('newMatchResults').innerHTML = 
                                `<div class="alert alert-danger">
                                    Error testing pattern: ${data.error}
                                </div>`;
                            document.getElementById('newMatchPreview').innerHTML = '';
                        }
                    })
                    .catch(error => {
                        document.getElementById('newMatchResults').innerHTML = 
                            `<div class="alert alert-danger">
                                Network error while testing pattern
                            </div>`;
                        console.error('Error testing pattern:', error);
                    });
            });
            
            // Save pattern changes
            document.getElementById('savePatternBtn').addEventListener('click', function() {
                document.getElementById('fixPatternForm').submit();
            });
            
            // Create new pattern
            document.getElementById('createPatternBtn').addEventListener('click', function() {
                document.getElementById('createPatternForm').submit();
            });
            
            // Delete pattern
            document.getElementById('deletePatternBtn').addEventListener('click', function() {
                const patternId = document.getElementById('editPatternId').value;
                if (confirm('Are you sure you want to delete this pattern?')) {
                    window.location.href = `/delete_pattern/${patternId}`;
                }
            });
            
            // False positive reporting
            const reportButtons = document.querySelectorAll('.report-false-positive');
            reportButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const entryId = this.dataset.entryId;
                    const patternId = this.dataset.patternId;
                    
                    fetch('/api/report_false_positive', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            entry_id: entryId,
                            pattern_id: patternId,
                            log_id: document.getElementById('currentLogId').value
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            this.innerHTML = '<i class="bi bi-check-circle"></i> Reported';
                            this.disabled = true;
                            alert('Thank you for your feedback. This will help improve pattern matching.');
                        } else {
                            alert('Error reporting false positive: ' + data.error);
                        }
                    })
                    .catch(error => {
                        console.error('Error reporting false positive:', error);
                        alert('Network error while reporting false positive');
                    });
                });
            });
            
            // Edit log message for pattern creation
            document.getElementById('editLogBtn').addEventListener('click', function() {
                const logMessage = document.getElementById('logMessage');
                logMessage.readOnly = !logMessage.readOnly;
                this.innerHTML = logMessage.readOnly ? 'Edit' : 'Lock';
                
                if (!logMessage.readOnly) {
                    logMessage.focus();
                } else {
                    // Regenerate the regex when locking the message
                    const message = logMessage.value;
                    const escapedMessage = message
                        .replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')
                        .replace(/\d+/g, '\\d+')
                        .replace(/[a-fA-F0-9]{8}-[a-fA-F0-9]{4}-[a-fA-F0-9]{4}-[a-fA-F0-9]{4}-[a-fA-F0-9]{12}/g, '[a-fA-F0-9\\-]+');
                    
                    document.getElementById('generatedRegex').value = escapedMessage;
                }
            });
            
            // Regenerate pattern button
            document.getElementById('regenerateBtn').addEventListener('click', function() {
                const message = document.getElementById('logMessage').value;
                // More sophisticated pattern generation
                let pattern = message;
                
                // Replace specific common patterns with regex alternatives
                pattern = pattern
                    .replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&') // Escape regex special chars
                    .replace(/\d+/g, '\\d+') // Numbers to digit pattern
                    .replace(/[a-fA-F0-9]{8}-[a-fA-F0-9]{4}-[a-fA-F0-9]{4}-[a-fA-F0-9]{4}-[a-fA-F0-9]{12}/g, '[a-fA-F0-9\\-]+') // UUIDs
                    .replace(/(["'])(?:(?=(\\?))\2.)*?\1/g, '["\'](.*?)["\']') // Quoted strings
                    .replace(/\b([a-zA-Z]:\\(?:[\w\s\-.]+\\)*[\w\s\-.]+)\b/g, '(?:\/|\\\\)[\w\s\-\.\\\\\/]+') // Windows paths
                    .replace(/\b(\/[\w\s\-.\/]+)\b/g, '(?:\/|\\\\)[\w\s\-\.\\\\\/]+'); // Unix paths
                
                document.getElementById('generatedRegex').value = pattern;
            });
        });
    </script>
    
    <style>
        /* Row highlighting */
        .highlight-row {
            background-color: rgba(25, 135, 84, 0.15) !important;
            border-left: 4px solid #198754;
        }
        
        /* Enhance table row hover */
        #entriesTable tbody tr {
            cursor: pointer;
            transition: all 0.2s;
        }
        
        #entriesTable tbody tr:hover {
            background-color: rgba(13, 110, 253, 0.1);
        }
        
        /* Add line numbers to context */
        .context-container {
            position: relative;
            max-height: 300px;
            overflow-y: auto;
        }
        
        /* Highlight the specific error line */
        .error-line {
            background-color: rgba(220, 53, 69, 0.2);
            font-weight: bold;
        }
        
        /* Filter input styling */
        #entryFilter, #levelFilter {
            background-color: var(--darker-bg);
            color: var(--text-light);
            border-color: var(--dark-border);
        }
        
        #entryFilter:focus, #levelFilter:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }
        
        /* Word-wrap for table cells and pre elements */
        .text-wrap {
            word-wrap: break-word;
            word-break: break-word;
            white-space: normal;
        }
        
        pre.text-wrap {
            white-space: pre-wrap;
            max-width: 100%;
            overflow-x: auto;
        }
        
        /* Set a reasonable width for the component column */
        #entriesTable th:nth-child(3),
        #entriesTable td:nth-child(3) {
            max-width: 150px;
        }
        
        /* Set a reasonable width for the message column */
        #entriesTable th:nth-child(4),
        #entriesTable td:nth-child(4) {
            max-width: 300px;
        }
    </style>
</body>
</html>